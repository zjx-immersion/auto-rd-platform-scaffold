# 需求池管理 - 问题排查记录

**日期**: 2026-01-28  
**分支**: feature/mvp-req-to-iteration  
**问题状态**: ❌ 未解决  

---

## 📋 任务目标

基于 `docs/设计规范/需求三层模型设计-V2.md` 完整实现需求池管理模块，包括：
- Epic管理（列表、详情、创建/编辑）
- FIP导入管理（导入、批次、记录、标注系统）

---

## ✅ 已完成的工作

### 1. 代码实现（100%完成）

#### 类型定义（5个文件）
- ✅ `src/types/domain/epic.ts` - Epic类型定义（完整）
- ✅ `src/types/domain/fip.ts` - FIP类型定义（完整）
- ✅ `src/types/domain/module.ts` - Module类型定义
- ✅ `src/types/domain/ticket.ts` - Ticket类型定义
- ✅ `src/types/common.ts` - 通用类型（已修正枚举值）

#### Mock数据（2个文件）
- ✅ `src/mock/epics.ts` - 6个Epic示例 + 评估数据
- ✅ `src/mock/fips.ts` - 2个FIP批次 + 5条记录

#### 页面组件（7个页面 + 7个CSS）
- ✅ `RequirementsPoolIndexPage` - 需求池入口页
- ✅ `EpicPoolPage` - Epic列表页
- ✅ `EpicDetailPage` - Epic详情页
- ✅ `EpicFormPage` - Epic创建/编辑表单
- ✅ `FIPImportPage` - FIP导入页
- ✅ `FIPBatchListPage` - FIP批次列表
- ✅ `FIPRecordsPage` - FIP记录表格（含标注系统）

#### 路由配置
- ✅ 在 `App.tsx` 中添加了完整的需求池路由
- ✅ 所有7个页面都已配置路由

### 2. Git提交记录

```bash
# 最近的提交（从新到旧）
1d73594 fix: 解决Epic类型定义冲突
14fc7aa fix: 添加缺失的FIP_IMPORT_BATCH_STATUS_COLORS导出
47d01f0 fix: 修正Priority和MoSCoW枚举值定义
8099397 fix: 修复eval保留关键字导致的编译错误
ad50bc1 docs: 添加需求池管理实施总结文档
554ad7c feat(requirements-pool): 添加需求池管理入口页面
8504fdc feat(requirements-pool): 配置路由并集成需求池管理
1ef4c95 feat(requirements-pool): 实现Epic表单、FIP导入和标注功能
bebc970 feat(requirements-pool): 实现Epic详情页面
31d69f5 feat(requirements-pool): 实现Epic池管理页面
ea79737 refactor(mvp): 重构为汽车行业三层需求模型 V2
```

---

## 🔴 核心问题

### 问题描述

**症状**: 
- 浏览器访问任何需求池页面都显示空白
- Console显示错误：`The requested module '/src/types/domain/epic.ts' does not provide an export named 'Epic'`

**错误详情**:
```
Uncaught SyntaxError: The requested module '/src/types/domain/epic.ts' 
does not provide an export named 'Epic' (at epics.ts:5:10)
```

**影响**:
- 所有需求池管理页面无法加载
- main分支可以正常工作
- 仅在feature/mvp-req-to-iteration分支出现此问题

---

## 🔧 已尝试的修复方案

### 修复1: eval保留关键字 ✅
**问题**: JavaScript不允许使用`eval`作为变量名  
**修复**: 将 `eval => evaluation`  
**结果**: 该问题已解决

### 修复2: Priority和MoSCoW枚举值不匹配 ✅
**问题**: `common.ts`中的枚举值与Mock数据不一致  
**修复**: 
- Priority: `P0/P1/P2/P3` → `CRITICAL/HIGH/MEDIUM/LOW`
- MoSCoW: `MUST/SHOULD/COULD/WONT` → `MUST_HAVE/SHOULD_HAVE/COULD_HAVE/WONT_HAVE`  
**结果**: 该问题已解决

### 修复3: 缺失的导出 ✅
**问题**: `FIP_IMPORT_BATCH_STATUS_COLORS` 未导出  
**修复**: 添加了颜色映射导出  
**结果**: 该问题已解决

### 修复4: Epic类型定义冲突 ✅
**问题**: 两个文件都定义了 `Epic` 接口
- `src/types/domain/epic.ts`（新的，完整的）
- `src/types/domain/requirement.ts`（旧的，简单的）

**修复**: 
- 从 `requirement.ts` 中删除了 `Epic` 和 `EpicStatus` 的定义
- 添加了 `import type { Epic } from './epic'`  
**结果**: 该问题已解决（但浏览器仍报错）

### 修复5: 清除Vite缓存 ❌
**尝试操作**:
```bash
# 删除Vite缓存
rm -rf node_modules/.vite

# 删除构建目录
rm -rf dist

# 重启开发服务器
npm run dev
```
**结果**: 服务器重启成功，但浏览器仍报同样的错误

### 修复6: 清理多个Vite进程 ❌
**问题**: 发现有多个Vite进程在后台运行，占用了7001-7008端口  
**尝试操作**:
```bash
# 停止所有相关进程
pkill -f "vite.*auto-rd-platform-scaffold"

# 重新启动
npm run dev
```
**结果**: 启动到新端口7008，服务器运行正常，但浏览器仍报错

---

## 🔍 验证信息

### 文件确认（已验证 ✅）

#### epic.ts 导出确认
```bash
$ head -80 src/types/domain/epic.ts | grep -E "(export|interface Epic)"
# 输出:
6: import type { BaseEntity, Priority, MoSCoW } from '../common'
10: export enum EpicSource {
19: export const EPIC_SOURCE_LABELS: Record<EpicSource, string> = {
28: export const EPIC_SOURCE_COLORS: Record<EpicSource, string> = {
39: export enum EpicStatus {
49: export const EPIC_STATUS_LABELS: Record<EpicStatus, string> = {
59: export const EPIC_STATUS_COLORS: Record<EpicStatus, string> = {
71: export interface Epic extends BaseEntity {
```

✅ **确认**: `Epic` 接口在第71行正确导出

#### epics.ts 导入确认
```bash
$ head -10 src/mock/epics.ts
# 输出:
import { Epic, EpicSource, EpicStatus, EpicEvaluation } from '@/types/domain/epic'
import { Priority, MoSCoW } from '@/types/common'
```

✅ **确认**: 导入语句正确

#### TypeScript编译检查
```bash
$ npx tsc --noEmit
# 无输出（无错误）
```

✅ **确认**: TypeScript编译通过，无类型错误

### 当前服务器状态

**运行端口**: http://localhost:7008/  
**启动日志**: 无错误信息  
**服务器状态**: ✅ 正常运行

---

## 🤔 问题分析

### 可能的原因

1. **浏览器模块缓存** ⭐ 最可能
   - 浏览器的ES Module缓存可能仍在使用旧版本
   - 硬刷新（Cmd+Shift+R）可能不够彻底
   - 建议：清除浏览器所有缓存

2. **循环依赖**
   - 可能存在模块间的循环依赖
   - 需要检查所有导入链

3. **路径解析问题**
   - `@/types/domain/epic` 路径可能解析失败
   - 虽然TypeScript编译通过，但Vite runtime可能有问题

4. **浏览器兼容性**
   - 可能是浏览器版本或设置问题

### 未排查的方向

1. ❓ 检查 `tsconfig.json` 的 paths 配置
2. ❓ 检查 `vite.config.ts` 的 alias 配置
3. ❓ 尝试使用相对路径 `../types/domain/epic` 而非 `@/types/domain/epic`
4. ❓ 检查是否有其他文件也导入了旧的 `Epic` 类型
5. ❓ 尝试在其他浏览器测试
6. ❓ 检查浏览器开发者工具的 Network 面板，查看实际加载的文件内容

---

## 📝 当前文件状态

### src/types/domain/epic.ts
- ✅ 存在
- ✅ 包含 `export interface Epic extends BaseEntity`
- ✅ 导出了所有必要的类型和常量

### src/types/domain/requirement.ts
- ✅ 已删除 `Epic` 和 `EpicStatus` 定义
- ✅ 添加了 `import type { Epic } from './epic'`

### src/mock/epics.ts
- ✅ 正确导入 `Epic` 类型
- ✅ Mock数据完整

### tsconfig.json
```json
{
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["src/*"]
    }
  }
}
```

### vite.config.ts
```typescript
resolve: {
  alias: {
    '@': path.resolve(__dirname, './src')
  }
}
```

---

## 🎯 下一步建议

### 优先级 1: 浏览器缓存彻底清理

1. **Chrome 完全重置**:
   ```
   设置 → 隐私和安全 → 清除浏览数据
   - 时间范围：全部
   - 勾选：缓存的图片和文件、网站设置
   - 点击"清除数据"
   ```

2. **使用隐私模式**:
   - 在无痕/隐私窗口中测试
   - 排除缓存干扰

3. **尝试其他浏览器**:
   - Safari
   - Firefox
   - Edge

### 优先级 2: 路径问题排查

1. **改用相对路径测试**:
   ```typescript
   // 在 src/mock/epics.ts 中
   // 从：
   import { Epic } from '@/types/domain/epic'
   // 改为：
   import { Epic } from '../types/domain/epic'
   ```

2. **检查实际加载的文件**:
   - 浏览器 DevTools → Network
   - 筛选 epic.ts
   - 查看 Response 内容是否正确

### 优先级 3: 模块依赖分析

1. **查找所有导入Epic的文件**:
   ```bash
   grep -r "import.*Epic" src/ --include="*.ts" --include="*.tsx"
   ```

2. **检查循环依赖**:
   ```bash
   npx madge --circular src/
   ```

### 优先级 4: 降级策略

如果问题持续无法解决，考虑：

1. **临时方案**: 将Epic类型内联到使用它的文件中
2. **回退方案**: 从main分支cherry-pick需要的更改
3. **重新实现**: 在新分支上重新实现，避免历史问题

---

## 📂 相关文件位置

### 核心文件
- `/Users/jxzhong/workspace/voyah-devops-solution/auto-rd-platform-scaffold/src/types/domain/epic.ts`
- `/Users/jxzhong/workspace/voyah-devops-solution/auto-rd-platform-scaffold/src/mock/epics.ts`
- `/Users/jxzhong/workspace/voyah-devops-solution/auto-rd-platform-scaffold/src/App.tsx`

### 配置文件
- `/Users/jxzhong/workspace/voyah-devops-solution/auto-rd-platform-scaffold/tsconfig.json`
- `/Users/jxzhong/workspace/voyah-devops-solution/auto-rd-platform-scaffold/vite.config.ts`

### 文档
- `/Users/jxzhong/workspace/voyah-devops-solution/auto-rd-platform-scaffold/docs/设计规范/需求三层模型设计-V2.md`
- `/Users/jxzhong/workspace/voyah-devops-solution/auto-rd-platform-scaffold/docs/实施记录/需求池管理实施总结.md`

---

## 🔗 关键信息

### 服务器信息
- **当前端口**: 7008
- **URL**: http://localhost:7008/requirements-pool
- **状态**: 运行正常，无编译错误

### Git信息
- **分支**: feature/mvp-req-to-iteration
- **最新提交**: 1d73594 (fix: 解决Epic类型定义冲突)
- **对比分支**: main（工作正常）

### 错误信息
```
Uncaught SyntaxError: The requested module '/src/types/domain/epic.ts' 
does not provide an export named 'Epic' (at epics.ts:5:10)
```

---

## 💡 重要发现

1. **代码本身是正确的** ✅
   - TypeScript编译通过
   - 服务器启动无错误
   - 所有导入导出都正确

2. **问题仅在浏览器运行时出现** ⚠️
   - 这表明是模块加载或缓存问题
   - 不是代码逻辑或类型错误

3. **main分支工作正常** ✅
   - 说明环境配置没问题
   - 问题是本分支的特定改动引起的

---

## 📌 待新Chat继续的任务

1. 尝试清除浏览器完整缓存并测试
2. 改用相对路径并测试
3. 检查浏览器Network面板加载的实际文件内容
4. 如仍未解决，考虑与main分支的详细对比
5. 检查是否有其他隐藏的模块依赖问题

---

**下一步**: 在新的Chat中，请首先尝试"优先级1: 浏览器缓存彻底清理"的方案。
